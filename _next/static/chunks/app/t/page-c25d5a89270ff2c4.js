(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[708],{3465:function(e,t,a){Promise.resolve().then(a.bind(a,9782))},9376:function(e,t,a){"use strict";var s=a(5475);a.o(s,"useSearchParams")&&a.d(t,{useSearchParams:function(){return s.useSearchParams}})},9782:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return u}});var s=a(7437),r=a(2265),i=a(9376),n=a(5526);async function l(e){let{data:t,error:a}=await n.O.from("highlights").select("paragraph_id, text, kind").eq("document_id",e);if(a)throw a;let s=e=>(null==e?void 0:e.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toLowerCase())||"",r=new Map;for(let e of null!=t?t:[]){var i;if("word"!==e.kind&&"sentence"!==e.kind)continue;let t=e.paragraph_id,a=String(e.text||"");if(!a.trim())continue;let n=s(a),l=null!==(i=r.get(t))&&void 0!==i?i:new Map;r.set(t,l);let c=l.get(n);c?c.freq+=1:l.set(n,{example_text:a,freq:1})}let l=[];for(let[e,t]of r.entries()){let a=Array.from(t.values()).sort((e,t)=>t.freq-e.freq).slice(0,200);l.push({paragraph_id:e,items:a})}return l}async function c(e){let{data:t,error:a}=await n.O.from("highlights").select("created_at, kind, text, user:profiles(full_name,id)").eq("document_id",e).order("created_at",{ascending:!1});if(a)throw a;return t}async function o(e){let{data:t,error:a}=await n.O.from("highlights").select("paragraph_id, text").eq("document_id",e);if(a)throw a;let s=new Set(["the","and","for","are","but","not","you","with","this","that","was","were","from","have","has","had","his","her","she","him","our","your","they","them","their","there","what","which","who","whom","where","when","why","how","all","any","can","could","just","too","very","into","onto","over","under","than","then","also","because","about","after","before","again","more","most","some","such","only","own","same","so","no","nor","few","down","up","out","off","on","in","at","by","to","of","a","an","as","it","is","be","or"]),r=e=>(null==e?void 0:e.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase())||"",i=new Map;for(let e of null!=t?t:[]){var l,c;let t=e.paragraph_id,a=r(String(e.text||""));if(!a.trim())continue;let n=a.split(/\W+/).filter(e=>e.length>2&&!s.has(e));if(!n.length)continue;let o=null!==(l=i.get(t))&&void 0!==l?l:new Map;for(let e of(i.set(t,o),n))o.set(e,(null!==(c=o.get(e))&&void 0!==c?c:0)+1)}let o=[];for(let[e,t]of i.entries()){let a=Array.from(t.entries()).map(e=>{let[t,a]=e;return{word:t,cnt:a}}).sort((e,t)=>t.cnt-e.cnt).slice(0,100);o.push({paragraph_id:e,items:a})}return o}function d(e){let{items:t}=e,a=Math.max(1,...t.map(e=>e.cnt)),r=[...t];return r.sort((e,t)=>e.word>t.word?1:-1),(0,s.jsx)("div",{className:"flex flex-wrap gap-x-3 gap-y-2 p-3 rounded-xl bg-slate-50 border border-slate-200",style:{lineHeight:1.1},children:r.map((e,t)=>{let r=12+Math.round(e.cnt/a*28),i=.6+e.cnt/a*.4;return(0,s.jsx)("span",{className:"select-none",style:{fontSize:r,opacity:i},title:"".concat(e.word," \xd7").concat(e.cnt),children:e.word},t)})})}function h(){let e=((0,i.useSearchParams)().get("code")||"").trim(),[t,a]=(0,r.useState)(null),[h,u]=(0,r.useState)("Document"),[m,f]=(0,r.useState)([]),[x,p]=(0,r.useState)([]),[g,j]=(0,r.useState)([]),[y,v]=(0,r.useState)([]),[w,N]=(0,r.useState)([]),[_,b]=(0,r.useState)("");(0,r.useEffect)(()=>{(async()=>{b("");let{data:t,error:s}=await n.O.from("documents").select("id,title").eq("short_code",e).maybeSingle();if(s){b(s.message);return}if(!t){b("Document not found for this code.");return}a(t.id),t.title&&u(t.title);let[{data:r},{data:i}]=await Promise.all([n.O.from("paragraphs").select("id,text").eq("document_id",t.id).order("idx"),n.O.from("highlights").select("paragraph_id,start_offset,end_offset").eq("document_id",t.id)]);f(null!=r?r:[]),p(null!=i?i:[]);try{let[e,a,s]=await Promise.all([l(t.id),c(t.id),o(t.id)]);j(e),v(a),N(s)}catch(e){var d;b(null!==(d=e.message)&&void 0!==d?d:String(e))}})()},[e]);let S=(0,r.useMemo)(()=>(function(e,t){var a,s,r;let i={};for(let e of t)(null!==(s=i[a=e.paragraph_id])&&void 0!==s?s:i[a]=[]).push(e);let n=[];for(let t of e){let e=t.text.length,a=Array(e).fill(0);for(let s of null!==(r=i[t.id])&&void 0!==r?r:[]){let t=Math.max(0,Math.min(e,s.start_offset)),r=Math.max(t,Math.min(e,s.end_offset));for(let e=t;e<r;e++)a[e]+=1}let s=a.reduce((e,t)=>t>e?t:e,0),l=[];if(0===e){n.push({id:t.id,parts:[{t:"",freq:0}],max:s});continue}let c=0;for(;c<e;){let s=a[c],r=c+1;for(;r<e&&a[r]===s;)r++;l.push({t:t.text.slice(c,r),freq:s}),c=r}n.push({id:t.id,parts:l,max:s})}return n})(m,x),[m,x]);return e?_?(0,s.jsx)("div",{className:"container py-10 text-red-600",children:_}):t?(0,s.jsxs)("main",{className:"container py-10 space-y-10",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:h}),(0,s.jsxs)("section",{className:"space-y-6",children:[S.map(e=>(0,s.jsx)("div",{className:"card leading-7",children:e.parts.map((t,a)=>{var r,i;return(0,s.jsx)("span",{style:{backgroundColor:(r=t.freq,i=e.max,r<=0||i<=0?"transparent":"hsl(48 96% ".concat(94-22*Math.max(0,Math.min(1,r/i)),"%)"))},children:t.t},a)})},e.id)),(0,s.jsx)("div",{className:"text-xs text-gray-600",children:"Heatmap color = frequency of student highlights."})]}),(0,s.jsxs)("section",{className:"space-y-2",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"Top Highlights"}),(0,s.jsx)("div",{className:"space-y-4",children:m.map((e,t)=>{var a;let r=g.find(t=>t.paragraph_id===e.id);return r&&(null===(a=r.items)||void 0===a?void 0:a.length)?(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsxs)("div",{className:"text-sm text-gray-600",children:["Paragraph ",t+1]}),(0,s.jsx)("ul",{className:"space-y-1",children:r.items.map((e,t)=>(0,s.jsxs)("li",{className:"text-sm",children:[(0,s.jsx)("span",{className:"font-medium",children:e.example_text})," ",(0,s.jsxs)("span",{className:"text-gray-600",children:["\xd7",e.freq]})]},t))})]},e.id):null})})]}),(0,s.jsxs)("section",{className:"space-y-2",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"Word Cloud"}),(0,s.jsx)("div",{className:"space-y-4",children:m.map((e,t)=>{var a;let r=w.find(t=>t.paragraph_id===e.id);return r&&(null===(a=r.items)||void 0===a?void 0:a.length)?(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsxs)("div",{className:"text-sm text-gray-600",children:["Paragraph ",t+1]}),(0,s.jsx)(d,{items:r.items})]},e.id):null})})]}),(0,s.jsxs)("section",{className:"space-y-2",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"Who highlighted what"}),(0,s.jsxs)("table",{className:"table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"User"}),(0,s.jsx)("th",{children:"Kind"}),(0,s.jsx)("th",{children:"Text"}),(0,s.jsx)("th",{children:"Time"})]})}),(0,s.jsx)("tbody",{children:y.map((e,t)=>{var a,r,i;return(0,s.jsxs)("tr",{className:"border-t",children:[(0,s.jsx)("td",{children:null!==(i=null===(a=e.user)||void 0===a?void 0:a.full_name)&&void 0!==i?i:null===(r=e.user)||void 0===r?void 0:r.id}),(0,s.jsx)("td",{className:"text-center",children:e.kind}),(0,s.jsx)("td",{className:"font-medium",children:e.text}),(0,s.jsx)("td",{className:"text-gray-600",children:new Date(e.created_at).toLocaleString()})]},t)})})]})]})]}):(0,s.jsx)("div",{className:"container py-10",children:"Loading…"}):(0,s.jsxs)("div",{className:"container py-10",children:["Missing ",(0,s.jsx)("code",{children:"code"})," in URL."]})}function u(){return(0,s.jsx)(r.Suspense,{fallback:(0,s.jsx)("div",{className:"container py-10",children:"Loading…"}),children:(0,s.jsx)(h,{})})}},5526:function(e,t,a){"use strict";a.d(t,{O:function(){return s}});let s=(0,a(8439).eI)("https://jjbsscygzuomnsfpzzex.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYnNzY3lnenVvbW5zZnB6emV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzQzMDksImV4cCI6MjA3MTYxMDMwOX0.kd3D0KsN0iekbJ9uPTEuQ0BTxAvopleychGiQ99ytsk")}},function(e){e.O(0,[439,971,117,744],function(){return e(e.s=3465)}),_N_E=e.O()}]);