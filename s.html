<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Student</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
  <style>
    body{ margin:0; font:16px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#0f172a; }
    .container{ max-width:960px; margin:0 auto; padding:36px 24px; }
    .h1{ font-size:24px; font-weight:700; margin-bottom:14px; }
    .card{ border:1px solid #e5e7eb; border-radius:16px; padding:18px 20px; box-shadow:0 1px 2px rgba(0,0,0,.04); background:#fff; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .label{ font-size:14px; font-weight:600; margin-bottom:6px; display:block; }
    .input{ width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; font-size:16px; }
    .btn{ background:#000; color:#fff; border:1px solid #000; border-radius:12px; padding:8px 12px; cursor:pointer; }
    .para{ margin:18px 0; }
    .chip{ display:inline-flex; align-items:center; gap:6px; background:#f1f5f9; border:1px solid #e5e7eb; border-radius:10px; padding:6px 10px; margin:6px 6px 0 0; font-size:13px; }
    .chip button{ border:none; background:transparent; cursor:pointer; color:#334155; }
    .hl{ background:#bbf7d0; } /* student’s own highlights: soft green */
  </style>
</head>
<body>
  <main class="container">
    <h1 id="title" class="h1">Loading…</h1>

    <section class="card" style="margin-bottom:14px">
      <div class="label">Your name (shown to teacher)</div>
      <div class="row">
        <input id="name" class="input" style="flex:1 1 420px" placeholder="Alice"/>
        <button id="save" class="btn">Save</button>
      </div>
    </section>

    <div id="paras"></div>
  </main>

  <script>
    // ---------- setup ----------
    const SUPABASE = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    const code = new URL(location.href).searchParams.get('code');
    const myName = () => (localStorage.getItem('eh_name') || '').trim();

    // Save name
    const nameInput = document.getElementById('name');
    nameInput.value = myName();
    document.getElementById('save').onclick = () => {
      localStorage.setItem('eh_name', (nameInput.value || '').trim());
      alert('Saved.');
    };

    // Helpers for selection offsets inside element
    function offsetWithin(container, node, nodeOffset) {
      const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
      let pos = 0;
      while (walker.nextNode()) {
        const t = walker.currentNode;
        if (t === node) return pos + nodeOffset;
        pos += t.data.length;
      }
      return pos;
    }
    function selectionIn(el) {
      const sel = window.getSelection();
      if (!sel || sel.isCollapsed) return null;
      const r = sel.getRangeAt(0);
      if (!el.contains(r.startContainer) || !el.contains(r.endContainer)) return null;
      const s = Math.min(offsetWithin(el, r.startContainer, r.startOffset),
                         offsetWithin(el, r.endContainer, r.endOffset));
      const e = Math.max(offsetWithin(el, r.startContainer, r.startOffset),
                         offsetWithin(el, r.endContainer, r.endOffset));
      const text = el.innerText.slice(s, e);
      return { start:s, end:e, text };
    }

    // Load document by short code
    (async () => {
      const { data: doc } = await SUPABASE.from('documents').select('id,title').eq('short_code', code).single();
      if (!doc) { alert('Invalid code'); return; }
      document.getElementById('title').textContent = doc.title;

      const { data: paras } = await SUPABASE.from('paragraphs').select('id,idx,text').eq('document_id', doc.id).order('idx');
      const container = document.getElementById('paras');
      container.innerHTML = '';

      for (const p of (paras || [])) {
        const wrap = document.createElement('section');
        wrap.className = 'card para';

        const display = document.createElement('div');
        display.style.cursor = 'text';
        display.textContent = p.text;
        wrap.appendChild(display);

        const chips = document.createElement('div');
        wrap.appendChild(chips);

        // Load ONLY my highlights for this paragraph
        async function refreshMy() {
          chips.innerHTML = '';
          const { data: myH } = await SUPABASE
            .from('highlights')
            .select('id,start_offset,end_offset,text')
            .eq('paragraph_id', p.id)
            .eq('user_name', myName());

          // paint my highlights
          paint(display, p.text, myH || []);

          // chips with remove
          (myH || []).forEach(h => {
            const chip = document.createElement('span');
            chip.className = 'chip';
            chip.textContent = h.text + ' ';
            const x = document.createElement('button'); x.textContent = '×';
            x.onclick = async () => {
              await SUPABASE.from('highlights').delete().eq('id', h.id).eq('user_name', myName());
              refreshMy();
            };
            chip.appendChild(x);
            chips.appendChild(chip);
          });
        }

        // On selection → insert highlight with my name
        display.addEventListener('mouseup', async () => {
          const who = myName();
          if (!who) { alert('Please enter your name, then Save.'); return; }
          const sel = selectionIn(display);
          if (!sel || !sel.text.trim()) return;

          await SUPABASE.from('highlights').insert({
            document_id: doc.id,
            paragraph_id: p.id,
            user_name: who,
            start_offset: sel.start,
            end_offset: sel.end,
            text: sel.text,
            kind: sel.text.trim().includes(' ') ? 'sentence' : 'word'
          });
          window.getSelection()?.removeAllRanges();
          refreshMy();
        });

        container.appendChild(wrap);
        await refreshMy();
      }
    })();

    // Paint ranges (my highlights only)
    function paint(el, full, ranges) {
      if (!ranges.length) { el.innerHTML = escapeHtml(full); return; }
      ranges.sort((a,b)=>a.start_offset-b.start_offset);
      const parts = [];
      let i=0;
      for (const r of ranges) {
        const s = r.start_offset, e = r.end_offset;
        if (i<s) parts.push({t:full.slice(i,s), hl:false});
        parts.push({t:full.slice(s,e), hl:true});
        i=e;
      }
      if (i<full.length) parts.push({t:full.slice(i), hl:false});
      el.innerHTML = parts.map(p => p.hl
        ? `<span class="hl">${escapeHtml(p.t)}</span>`
        : escapeHtml(p.t)).join('');
    }
    function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]))}
  </script>
</body>
</html>
