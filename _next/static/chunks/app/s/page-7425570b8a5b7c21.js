(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[905],{5767:function(e,t,s){Promise.resolve().then(s.bind(s,3741))},9376:function(e,t,s){"use strict";var n=s(5475);s.o(n,"useSearchParams")&&s.d(t,{useSearchParams:function(){return n.useSearchParams}})},3741:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return u}});var n,r=s(7437),a=s(2265),i=s(9376),l=s(5526);function d(e,t,s){let n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),r=0;for(;n.nextNode();){let e=n.currentNode;if(e===t)return r+s;r+=e.data.length}return r}function c(e){let{paragraph:t,documentId:s,userId:n}=e,i=(0,a.useRef)(null),[c,o]=(0,a.useState)([]),[u,f]=(0,a.useState)("");async function h(){var e,r;if(!n){f("Please sign in.");return}let a=function(e){let t=window.getSelection();if(!t||t.isCollapsed)return null;let s=t.getRangeAt(0);if(!e.contains(s.startContainer)||!e.contains(s.endContainer))return null;let n=d(e,s.startContainer,s.startOffset),r=d(e,s.endContainer,s.endOffset),a=Math.min(n,r),i=Math.max(n,r),l=e.innerText.slice(a,i);return{start:a,end:i,text:l}}(i.current);if(a&&0!==a.text.trim().length)try{let r=a.text.trim().includes(" ")?"sentence":"word",i=await l.O.from("highlights").insert({document_id:s,paragraph_id:t.id,user_id:n,start_offset:a.start,end_offset:a.end,text:a.text,kind:r}).select("id,start_offset,end_offset,text").single();if(i.error)throw i.error;let d=i.data;o(e=>[...e,d]),null===(e=window.getSelection())||void 0===e||e.removeAllRanges()}catch(e){f(null!==(r=e.message)&&void 0!==r?r:String(e))}}async function m(e){try{let t=await l.O.from("highlights").delete().eq("id",e).eq("user_id",n);if(t.error)throw t.error;o(t=>t.filter(t=>t.id!==e))}catch(e){var t;f(null!==(t=e.message)&&void 0!==t?t:String(e))}}(0,a.useEffect)(()=>{if(!n)return;(async()=>{let{data:e,error:s}=await l.O.from("highlights").select("id,start_offset,end_offset,text").eq("paragraph_id",t.id).eq("user_id",n).order("created_at",{ascending:!0});s||o(null!=e?e:[])})();let e=l.O.channel("hl-".concat(t.id,"-").concat(n)).on("postgres_changes",{event:"INSERT",schema:"public",table:"highlights",filter:"paragraph_id=eq."+t.id},e=>{let t=e.new;t&&t.user_id===n&&o(e=>[...e,{id:t.id,start_offset:t.start_offset,end_offset:t.end_offset,text:t.text}])}).on("postgres_changes",{event:"DELETE",schema:"public",table:"highlights",filter:"paragraph_id=eq."+t.id},e=>{let t=e.old;t&&o(e=>e.filter(e=>e.id!==t.id))}).subscribe();return()=>{l.O.removeChannel(e)}},[t.id,n]);let x=(0,a.useMemo)(()=>{let e=c.map(e=>({start:e.start_offset,end:e.end_offset}));if(!e.length)return[];e.sort((e,t)=>e.start-t.start);let t=[{...e[0]}];for(let s of e.slice(1)){let e=t[t.length-1];s.start<=e.end?e.end=Math.max(e.end,s.end):t.push({...s})}return t},[c]),g=(0,a.useMemo)(()=>{let e=t.text;if(!x.length)return[{t:e,hl:!1}];let s=[],n=0;for(let t of x)n<t.start&&s.push({t:e.slice(n,t.start),hl:!1}),s.push({t:e.slice(t.start,t.end),hl:!0}),n=t.end;return n<e.length&&s.push({t:e.slice(n),hl:!1}),s},[x,t.text]);return(0,r.jsxs)("div",{className:"leading-7 space-y-2",children:[u&&(0,r.jsx)("div",{className:"text-red-600 text-sm",children:u}),(0,r.jsx)("div",{ref:i,onMouseUp:h,className:"cursor-text select-text",children:g.map((e,t)=>(0,r.jsx)("span",{className:e.hl?"bg-emerald-200":"",children:e.t},t))}),c.length>0&&(0,r.jsx)("div",{className:"flex flex-wrap gap-2 pt-1",children:c.map(e=>{let t=e.text.length>32?e.text.slice(0,32)+"…":e.text;return(0,r.jsxs)("button",{onClick:()=>m(e.id),className:"text-xs px-2 py-1 border rounded-lg hover:bg-red-50",title:"Remove this highlight",children:[t," \xd7"]},e.id)})})]})}let o=null!==(n=s(257).env.NEXT_PUBLIC_BASE_PATH)&&void 0!==n?n:"";function u(){return(0,r.jsx)(a.Suspense,{fallback:(0,r.jsx)("div",{}),children:(0,r.jsx)(f,{})})}function f(){let e=(0,i.useSearchParams)().get("code")||"",[t,s]=(0,a.useState)(null),[n,d]=(0,a.useState)([]),[u,f]=(0,a.useState)(!0),[h,m]=(0,a.useState)(""),[x,g]=(0,a.useState)(""),[p,v]=(0,a.useState)(""),[_,b]=(0,a.useState)(!1),[N,y]=(0,a.useState)("");async function S(){if(!x){alert("Setting up your session — please try again in a moment.");return}b(!0);try{await l.O.from("profiles").upsert({id:x,full_name:p.trim()||"Guest"}),y("Saved"),setTimeout(()=>y(""),1200)}catch(e){console.error(e),alert("Failed to save.")}finally{b(!1)}}(0,a.useEffect)(()=>{(async()=>{var e;let{data:t}=await l.O.auth.getUser(),s=(null===(e=t.user)||void 0===e?void 0:e.id)||"";if(g(s),s){let{data:e}=await l.O.from("profiles").select("full_name").eq("id",s).single();(null==e?void 0:e.full_name)&&v(e.full_name)}})()},[]),(0,a.useEffect)(()=>{if(!e){m("Missing code.");return}let t=!1;return(async()=>{f(!0),m("");let{data:n,error:r}=await l.O.from("documents").select("id,title,short_code").eq("short_code",e).single();if(r){t||(m(r.message),f(!1));return}if(t)return;s(n);let{data:a,error:i}=await l.O.from("paragraphs").select("id,text,idx").eq("document_id",n.id).order("idx",{ascending:!0});if(i){t||(m(i.message),f(!1));return}t||(d((null!=a?a:[]).map(e=>({id:e.id,text:e.text}))),f(!1))})(),()=>{t=!0}},[e]);let j=(0,a.useMemo)(()=>{var e;return null!==(e=null==t?void 0:t.title)&&void 0!==e?e:"Student"},[t]);return(0,r.jsxs)("main",{className:"max-w-3xl mx-auto px-4 py-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-4 mb-4",children:[(0,r.jsx)("h1",{className:"text-xl font-semibold",children:j}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("input",{className:"border rounded-md px-3 py-2 text-sm",value:p,onChange:e=>v(e.target.value),placeholder:"Your name"}),(0,r.jsx)("button",{type:"button",className:"px-3 py-2 rounded-md bg-black text-white hover:bg-neutral-900 disabled:opacity-50",onClick:S,disabled:!x||_,children:_?"Saving…":"Save"}),N&&(0,r.jsx)("span",{className:"text-xs text-gray-600",children:N})]})]}),h&&(0,r.jsx)("div",{className:"text-red-600 mb-4",children:h}),u&&(0,r.jsx)("div",{className:"text-gray-500",children:"Loading…"}),!u&&0===n.length&&(0,r.jsx)("div",{className:"text-gray-600",children:"No document content yet."}),(0,r.jsx)("div",{className:"space-y-6",children:t&&n.map(e=>(0,r.jsx)(c,{paragraph:{id:e.id,text:e.text},documentId:t.id,userId:x},e.id))}),(0,r.jsx)("div",{className:"mt-10",children:(0,r.jsx)("a",{className:"underline",href:"".concat(o,"/t?code=").concat(e),children:"Open Teacher View"})})]})}},5526:function(e,t,s){"use strict";s.d(t,{O:function(){return n}});let n=(0,s(8439).eI)("https://jjbsscygzuomnsfpzzex.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYnNzY3lnenVvbW5zZnB6emV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzQzMDksImV4cCI6MjA3MTYxMDMwOX0.kd3D0KsN0iekbJ9uPTEuQ0BTxAvopleychGiQ99ytsk")}},function(e){e.O(0,[439,971,117,744],function(){return e(e.s=5767)}),_N_E=e.O()}]);