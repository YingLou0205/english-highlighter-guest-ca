(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[905],{5767:function(e,t,n){Promise.resolve().then(n.bind(n,3741))},9376:function(e,t,n){"use strict";var s=n(5475);n.o(s,"useSearchParams")&&n.d(t,{useSearchParams:function(){return s.useSearchParams}})},3741:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return o}});var s=n(7437),a=n(2265),i=n(9376),r=n(5526);function l(e,t,n){let s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),a=0;for(;s.nextNode();){let e=s.currentNode;if(e===t)return a+n;a+=e.data.length}return a}function c(e){let{paragraph:t,documentId:n,userId:i}=e,c=(0,a.useRef)(null),d=(0,a.useRef)(0),[o,u]=(0,a.useState)([]),[h,f]=(0,a.useState)("");async function m(){var e,s;if(!i){f("Please sign in.");return}let a=c.current;if(!a)return;let d=function(e){let t=window.getSelection();if(!t||t.isCollapsed)return null;let n=t.getRangeAt(0);if(!e.contains(n.startContainer)||!e.contains(n.endContainer))return null;let s=l(e,n.startContainer,n.startOffset),a=l(e,n.endContainer,n.endOffset),i=Math.min(s,a),r=Math.max(s,a),c=e.innerText.slice(i,r);return{start:i,end:r,text:c}}(a);if(d&&0!==d.text.trim().length)try{let s=d.text.trim().includes(" ")?"sentence":"word",a=await r.O.from("highlights").insert({document_id:n,paragraph_id:t.id,user_id:i,start_offset:d.start,end_offset:d.end,text:d.text,kind:s}).select("id,start_offset,end_offset,text").single();if(a.error)throw a.error;let l=a.data;u(e=>[...e,l]),null===(e=window.getSelection())||void 0===e||e.removeAllRanges()}catch(e){f(null!==(s=e.message)&&void 0!==s?s:String(e))}}function g(){let e=Date.now();e-d.current<250||(d.current=e,setTimeout(()=>{m()},0))}async function p(e){try{let t=await r.O.from("highlights").delete().eq("id",e).eq("user_id",i);if(t.error)throw t.error;u(t=>t.filter(t=>t.id!==e))}catch(e){var t;f(null!==(t=e.message)&&void 0!==t?t:String(e))}}(0,a.useEffect)(()=>{if(!i)return;(async()=>{let{data:e,error:n}=await r.O.from("highlights").select("id,start_offset,end_offset,text").eq("paragraph_id",t.id).eq("user_id",i).order("created_at",{ascending:!0});n||u(null!=e?e:[])})();let e=r.O.channel("hl-".concat(t.id,"-").concat(i)).on("postgres_changes",{event:"INSERT",schema:"public",table:"highlights",filter:"paragraph_id=eq."+t.id},e=>{let t=e.new;t&&t.user_id===i&&u(e=>[...e,{id:t.id,start_offset:t.start_offset,end_offset:t.end_offset,text:t.text}])}).on("postgres_changes",{event:"DELETE",schema:"public",table:"highlights",filter:"paragraph_id=eq."+t.id},e=>{let t=e.old;t&&u(e=>e.filter(e=>e.id!==t.id))}).subscribe();return()=>{r.O.removeChannel(e)}},[t.id,i]);let x=(0,a.useMemo)(()=>{let e=o.map(e=>({start:e.start_offset,end:e.end_offset}));if(!e.length)return[];e.sort((e,t)=>e.start-t.start);let t=[{...e[0]}];for(let n of e.slice(1)){let e=t[t.length-1];n.start<=e.end?e.end=Math.max(e.end,n.end):t.push({...n})}return t},[o]),_=(0,a.useMemo)(()=>{let e=t.text;if(!x.length)return[{t:e,hl:!1}];let n=[],s=0;for(let t of x)s<t.start&&n.push({t:e.slice(s,t.start),hl:!1}),n.push({t:e.slice(t.start,t.end),hl:!0}),s=t.end;return s<e.length&&n.push({t:e.slice(s),hl:!1}),n},[x,t.text]);return(0,s.jsxs)("div",{className:"leading-7 space-y-2",children:[h&&(0,s.jsx)("div",{className:"text-red-600 text-sm",children:h}),(0,s.jsx)("div",{ref:c,onMouseUp:g,onPointerUp:g,onTouchEnd:g,className:"cursor-text select-text",children:_.map((e,t)=>(0,s.jsx)("span",{className:e.hl?"bg-emerald-200":"",children:e.t},t))}),o.length>0&&(0,s.jsx)("div",{className:"flex flex-wrap gap-2 pt-1",children:o.map(e=>{let t=e.text.length>32?e.text.slice(0,32)+"…":e.text;return(0,s.jsxs)("button",{onClick:()=>p(e.id),className:"text-sm px-3 py-2 border rounded-lg hover:bg-red-50 min-h-9",title:"Remove this highlight",children:[t," \xd7"]},e.id)})})]})}function d(){let e=((0,i.useSearchParams)().get("code")||"").trim(),[t,n]=(0,a.useState)(null),[l,d]=(0,a.useState)("Document"),[o,u]=(0,a.useState)([]),[h,f]=(0,a.useState)(""),[m,g]=(0,a.useState)(""),[p,x]=(0,a.useState)("");async function _(){try{x("");let e=h;if(!e){(await r.O.auth.getSession()).data.session||await r.O.auth.signInAnonymously();let t=(await r.O.auth.getUser()).data.user;t&&(e=t.id,f(t.id))}if(!e)throw Error("Unable to sign in. Please try again.");let t=m.trim()||"Guest",{error:n}=await r.O.from("profiles").upsert({id:e,full_name:t});if(n)throw n}catch(t){var e;x(null!==(e=t.message)&&void 0!==e?e:String(t))}}return((0,a.useEffect)(()=>{(async()=>{x(""),(await r.O.auth.getSession()).data.session||await r.O.auth.signInAnonymously();let t=(await r.O.auth.getUser()).data.user;if(t){f(t.id);let{data:e}=await r.O.from("profiles").select("full_name").eq("id",t.id).maybeSingle();(null==e?void 0:e.full_name)&&g(e.full_name)}let{data:s,error:a}=await r.O.from("documents").select("id,title").eq("short_code",e).maybeSingle();if(a){x(a.message);return}if(!s){x("Document not found for this code.");return}n(s.id),s.title&&d(s.title);let{data:i,error:l}=await r.O.from("paragraphs").select("id,text").eq("document_id",s.id).order("idx");if(l){x(l.message);return}u(null!=i?i:[])})()},[e]),e)?p?(0,s.jsx)("div",{className:"container py-10 text-red-600",children:p}):t?(0,s.jsxs)("main",{className:"container py-10 space-y-6",children:[(0,s.jsx)("h1",{className:"text-xl font-semibold",children:l}),(0,s.jsxs)("div",{className:"card max-w-lg space-y-2",children:[(0,s.jsx)("div",{className:"text-sm font-medium",children:"Your name (shown to teacher)"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("input",{className:"input",value:m,onChange:e=>g(e.target.value),placeholder:"e.g., Ying"}),(0,s.jsx)("button",{className:"btn btn-primary",onClick:_,children:"Save"})]})]}),(0,s.jsx)("div",{className:"space-y-6",children:o.map(e=>(0,s.jsx)("div",{className:"card",children:(0,s.jsx)(c,{paragraph:e,documentId:t,userId:h})},e.id))})]}):(0,s.jsx)("div",{className:"container py-10",children:"Loading…"}):(0,s.jsxs)("div",{className:"container py-10",children:["Missing ",(0,s.jsx)("code",{children:"code"})," in URL."]})}function o(){return(0,s.jsx)(a.Suspense,{fallback:(0,s.jsx)("div",{className:"container py-10",children:"Loading…"}),children:(0,s.jsx)(d,{})})}},5526:function(e,t,n){"use strict";n.d(t,{O:function(){return s}});let s=(0,n(8439).eI)("https://jjbsscygzuomnsfpzzex.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYnNzY3lnenVvbW5zZnB6emV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzQzMDksImV4cCI6MjA3MTYxMDMwOX0.kd3D0KsN0iekbJ9uPTEuQ0BTxAvopleychGiQ99ytsk")}},function(e){e.O(0,[439,971,117,744],function(){return e(e.s=5767)}),_N_E=e.O()}]);