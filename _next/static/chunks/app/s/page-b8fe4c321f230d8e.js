(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[905],{5767:function(e,t,s){Promise.resolve().then(s.bind(s,3741))},9376:function(e,t,s){"use strict";var a=s(5475);s.o(a,"useSearchParams")&&s.d(t,{useSearchParams:function(){return a.useSearchParams}})},3741:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return d}});var a=s(7437),n=s(2265),i=s(9376),r=s(5526);function l(e,t,s){let a=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=0;for(;a.nextNode();){let e=a.currentNode;if(e===t)return n+s;n+=e.data.length}return n}function o(e){let{paragraph:t,documentId:s,userId:i}=e,o=(0,n.useRef)(null),c=(0,n.useRef)(0),[d,u]=(0,n.useState)([]),[h,m]=(0,n.useState)("");async function f(){var e,a;if(!i){m("Please sign in.");return}let n=o.current;if(!n)return;let c=function(e){let t=window.getSelection();if(!t||t.isCollapsed)return null;let s=t.getRangeAt(0);if(!e.contains(s.startContainer)||!e.contains(s.endContainer))return null;let a=l(e,s.startContainer,s.startOffset),n=l(e,s.endContainer,s.endOffset),i=Math.min(a,n),r=Math.max(a,n),o=e.innerText.slice(i,r);return{start:i,end:r,text:o}}(n);if(c&&0!==c.text.trim().length)try{let a=c.text.trim().includes(" ")?"sentence":"word",n=await r.O.from("highlights").insert({document_id:s,paragraph_id:t.id,user_id:i,start_offset:c.start,end_offset:c.end,text:c.text,kind:a}).select("id,start_offset,end_offset,text").single();if(n.error)throw n.error;let l=n.data;u(e=>[...e,l]),null===(e=window.getSelection())||void 0===e||e.removeAllRanges()}catch(e){m(null!==(a=e.message)&&void 0!==a?a:String(e))}}function g(){let e=Date.now();e-c.current<250||(c.current=e,setTimeout(()=>{f()},0))}async function p(e){try{let t=await r.O.from("highlights").delete().eq("id",e).eq("user_id",i);if(t.error)throw t.error;u(t=>t.filter(t=>t.id!==e))}catch(e){var t;m(null!==(t=e.message)&&void 0!==t?t:String(e))}}(0,n.useEffect)(()=>{if(!i)return;(async()=>{let{data:e,error:s}=await r.O.from("highlights").select("id,start_offset,end_offset,text").eq("paragraph_id",t.id).eq("user_id",i).order("created_at",{ascending:!0});s||u(null!=e?e:[])})();let e=r.O.channel("hl-".concat(t.id,"-").concat(i)).on("postgres_changes",{event:"INSERT",schema:"public",table:"highlights",filter:"paragraph_id=eq."+t.id},e=>{let t=e.new;t&&t.user_id===i&&u(e=>[...e,{id:t.id,start_offset:t.start_offset,end_offset:t.end_offset,text:t.text}])}).on("postgres_changes",{event:"DELETE",schema:"public",table:"highlights",filter:"paragraph_id=eq."+t.id},e=>{let t=e.old;t&&u(e=>e.filter(e=>e.id!==t.id))}).subscribe();return()=>{r.O.removeChannel(e)}},[t.id,i]);let x=(0,n.useMemo)(()=>{let e=d.map(e=>({start:e.start_offset,end:e.end_offset}));if(!e.length)return[];e.sort((e,t)=>e.start-t.start);let t=[{...e[0]}];for(let s of e.slice(1)){let e=t[t.length-1];s.start<=e.end?e.end=Math.max(e.end,s.end):t.push({...s})}return t},[d]),v=(0,n.useMemo)(()=>{let e=t.text;if(!x.length)return[{t:e,hl:!1}];let s=[],a=0;for(let t of x)a<t.start&&s.push({t:e.slice(a,t.start),hl:!1}),s.push({t:e.slice(t.start,t.end),hl:!0}),a=t.end;return a<e.length&&s.push({t:e.slice(a),hl:!1}),s},[x,t.text]);return(0,a.jsxs)("div",{className:"leading-7 space-y-2",children:[h&&(0,a.jsx)("div",{className:"text-red-600 text-sm",children:h}),(0,a.jsx)("div",{ref:o,onMouseUp:g,onPointerUp:g,onTouchEnd:g,className:"cursor-text select-text",children:v.map((e,t)=>(0,a.jsx)("span",{className:e.hl?"bg-emerald-200":"",children:e.t},t))}),d.length>0&&(0,a.jsx)("div",{className:"flex flex-wrap gap-2 pt-1",children:d.map(e=>{let t=e.text.length>32?e.text.slice(0,32)+"…":e.text;return(0,a.jsxs)("button",{onClick:()=>p(e.id),className:"text-sm px-3 py-2 border rounded-lg hover:bg-red-50 min-h-9",title:"Remove this highlight",children:[t," \xd7"]},e.id)})})]})}function c(){let e=((0,i.useSearchParams)().get("code")||"").trim(),[t,s]=(0,n.useState)(null),[l,c]=(0,n.useState)("Document"),[d,u]=(0,n.useState)([]),[h,m]=(0,n.useState)(""),[f,g]=(0,n.useState)(""),[p,x]=(0,n.useState)(""),[v,N]=(0,n.useState)(""),[w,y]=(0,n.useState)("");async function _(){try{x("");let e=h;if(!e){(await r.O.auth.getSession()).data.session||await r.O.auth.signInAnonymously();let t=(await r.O.auth.getUser()).data.user;t&&(e=t.id,m(t.id))}if(!e)throw Error("Unable to sign in. Please try again.");let t=f.trim()||"Guest",{error:s}=await r.O.from("profiles").upsert({id:e,full_name:t});if(s)throw s}catch(t){var e;x(null!==(e=t.message)&&void 0!==e?e:String(t))}}async function j(){try{if(x(""),y(""),!t)throw Error("No document");if(!f.trim())throw Error("Enter a name");if(!/^\d{4,}$/.test(v))throw Error("PIN must be at least 4 digits");(await r.O.auth.getSession()).data.session||await r.O.auth.signInAnonymously();let{error:e}=await r.O.rpc("set_alias",{doc:t,alias_in:f.trim(),pin_in:v});if(e)throw e;y("Name + PIN saved for this class. Use the same on other devices to sync.")}catch(t){var e;x(null!==(e=t.message)&&void 0!==e?e:String(t))}}async function b(){try{if(x(""),y(""),!t)throw Error("No document");if(!f.trim())throw Error("Enter your saved name");if(!/^\d{4,}$/.test(v))throw Error("PIN must be at least 4 digits");(await r.O.auth.getSession()).data.session||await r.O.auth.signInAnonymously();let{error:e}=await r.O.rpc("claim_alias",{doc:t,alias_in:f.trim(),pin_in:v});if(e)throw e;y("This device is now linked. Your highlights have been synced.")}catch(t){var e;x(null!==(e=t.message)&&void 0!==e?e:String(t))}}return((0,n.useEffect)(()=>{(async()=>{x(""),(await r.O.auth.getSession()).data.session||await r.O.auth.signInAnonymously();let t=(await r.O.auth.getUser()).data.user;if(t){m(t.id);let{data:e}=await r.O.from("profiles").select("full_name").eq("id",t.id).maybeSingle();(null==e?void 0:e.full_name)&&g(e.full_name)}let{data:a,error:n}=await r.O.from("documents").select("id,title").eq("short_code",e).maybeSingle();if(n){x(n.message);return}if(!a){x("Document not found for this code.");return}s(a.id),a.title&&c(a.title);let{data:i,error:l}=await r.O.from("paragraphs").select("id,text").eq("document_id",a.id).order("idx");if(l){x(l.message);return}u(null!=i?i:[])})()},[e]),e)?p?(0,a.jsx)("div",{className:"container py-10 text-red-600",children:p}):t?(0,a.jsxs)("main",{className:"container py-10 space-y-6",children:[(0,a.jsx)("h1",{className:"text-xl font-semibold",children:l}),(0,a.jsxs)("div",{className:"card max-w-lg space-y-2",children:[(0,a.jsx)("div",{className:"text-sm font-medium",children:"Your name (shown to teacher)"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{className:"input",value:f,onChange:e=>g(e.target.value),placeholder:"e.g., Ying"}),(0,a.jsx)("button",{className:"btn btn-primary",onClick:_,children:"Save"})]})]}),(0,a.jsxs)("div",{className:"card max-w-lg space-y-2",children:[(0,a.jsx)("div",{className:"text-sm font-medium",children:"Use the same highlights on phone/tablet/desktop"}),(0,a.jsx)("div",{className:"text-xs text-gray-600",children:"Set a PIN once, then reuse Name + PIN on other devices."}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{className:"input",value:f,onChange:e=>g(e.target.value),placeholder:"Your name"}),(0,a.jsx)("input",{className:"input",value:v,onChange:e=>N(e.target.value),placeholder:"PIN (4+ digits)",inputMode:"numeric",pattern:"\\d*"})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("button",{className:"btn",onClick:j,children:"Save Name + PIN"}),(0,a.jsx)("button",{className:"btn",onClick:b,children:"Use on this device"})]}),w&&(0,a.jsx)("div",{className:"text-xs text-green-700",children:w})]}),(0,a.jsx)("div",{className:"space-y-6",children:d.map(e=>(0,a.jsx)("div",{className:"card",children:(0,a.jsx)(o,{paragraph:e,documentId:t,userId:h})},e.id))})]}):(0,a.jsx)("div",{className:"container py-10",children:"Loading…"}):(0,a.jsxs)("div",{className:"container py-10",children:["Missing ",(0,a.jsx)("code",{children:"code"})," in URL."]})}function d(){return(0,a.jsx)(n.Suspense,{fallback:(0,a.jsx)("div",{className:"container py-10",children:"Loading…"}),children:(0,a.jsx)(c,{})})}},5526:function(e,t,s){"use strict";s.d(t,{O:function(){return a}});let a=(0,s(8439).eI)("https://jjbsscygzuomnsfpzzex.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYnNzY3lnenVvbW5zZnB6emV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzQzMDksImV4cCI6MjA3MTYxMDMwOX0.kd3D0KsN0iekbJ9uPTEuQ0BTxAvopleychGiQ99ytsk")}},function(e){e.O(0,[439,971,117,744],function(){return e(e.s=5767)}),_N_E=e.O()}]);