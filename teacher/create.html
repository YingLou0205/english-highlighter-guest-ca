<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Create a Document</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../config.js"></script>
  <style>
    body{ margin:0; font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#0f172a; }
    .container{ max-width:960px; margin:0 auto; padding:48px 24px; }
    .title{ font-size:26px; font-weight:700; margin:0 0 18px; }
    .card{ border:1px solid #e5e7eb; border-radius:16px; padding:24px; box-shadow:0 1px 2px rgba(0,0,0,.04); background:#fff; }
    .label{ font-size:14px; font-weight:600; display:block; margin-bottom:6px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .input, textarea{ width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:12px; font-size:16px; outline:none; }
    textarea{ min-height:240px; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px; text-decoration:none; background:#000; color:#fff; border:1px solid #000; cursor:pointer; }
    .muted{ color:#64748b; font-size:13px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; }
    .copy{ padding:6px 10px; border-radius:10px; background:#000; color:#fff; border:1px solid #000; cursor:pointer; }
  </style>
</head>
<body>
  <main class="container">
    <h1 class="title">Create a Document</h1>

    <section class="card" style="max-width:760px; margin-bottom:18px;">
      <label class="label">Your display name (shown to class)</label>
      <div class="row">
        <input id="name" class="input" placeholder="e.g., Ying" style="flex:1 1 420px"/>
        <button id="saveName" class="btn">Save name</button>
      </div>
    </section>

    <section class="card" style="max-width:760px;">
      <label class="label">Title</label>
      <input id="title" class="input" placeholder="A great summer vacation"/>
      <label class="label" style="margin-top:12px">Content (blank line = new paragraph)</label>
      <textarea id="content" class="input" placeholder="Paragraph 1...\n\nParagraph 2..."></textarea>
      <div style="margin-top:12px">
        <button id="createBtn" class="btn">Create document</button>
      </div>
    </section>

    <section id="result" class="card" style="max-width:760px; margin-top:18px; display:none;">
      <div class="muted">✅ Document created.</div>
      <div class="row" style="margin-top:12px;">
        <span class="pill" style="flex:1 1 320px;">
          <span class="muted">Document ID</span>
          <span id="docId" class="mono" style="margin-left:8px;"></span>
          <button id="copyDocId" class="copy">Copy</button>
        </span>
        <span class="pill" style="flex:0 0 280px;">
          <span class="muted">Short Code</span>
          <span id="shortCode" class="mono" style="margin-left:8px;"></span>
          <button id="copyShort" class="copy">Copy</button>
        </span>
      </div>
      <div class="row" style="margin-top:12px;">
        <a id="openStudent" class="btn" href="#">Open Student View</a>
        <a id="openTeacher" class="btn" href="#">Open Teacher View</a>
        <span class="muted">Tip: Short Code was copied automatically.</span>
      </div>
    </section>
  </main>

  <script>
    const BASE = location.pathname.includes('/english-highlighter-guest-ca')
      ? '/english-highlighter-guest-ca' : '';

    const supabase = window.supabase.createClient(
      window.SUPABASE_URL, window.SUPABASE_ANON_KEY
    );

    // Name persist
    const nameInput = document.getElementById('name');
    nameInput.value = localStorage.getItem('eh_name') || '';
    document.getElementById('saveName').onclick = () => {
      localStorage.setItem('eh_name', (nameInput.value || '').trim());
      alert('Saved.');
    };

    async function createDocument() {
      const title = (document.getElementById('title').value || '').trim();
      const content = (document.getElementById('content').value || '').trim();
      if (!title || !content) { alert('Please fill in title and content.'); return; }

      // 1) Create document
      const { data: doc, error: e1 } = await supabase
        .from('documents')
        .insert({ title, content })               // classless guest mode
        .select()
        .single();
      if (e1) { alert(e1.message); return; }

      // 2) Split paragraphs
      const paras = content.split(/\n\s*\n+/).map(s => s.trim()).filter(Boolean);
      if (paras.length) {
        const rows = paras.map((text, idx) => ({ document_id: doc.id, idx, text }));
        const { error: e2 } = await supabase.from('paragraphs').insert(rows);
        if (e2) { alert(e2.message); return; }
      }

      // 3) Short code (8 hex) – stored on documents.short_code (add column once in SQL)
      let short = (Math.random().toString(16).slice(2, 10)).padEnd(8, '0');
      await supabase.from('documents').update({ short_code: short }).eq('id', doc.id);

      // Show result
      const rs = document.getElementById('result');
      rs.style.display = '';
      document.getElementById('docId').textContent = doc.id;
      document.getElementById('shortCode').textContent = short;
      document.getElementById('copyDocId').onclick = () => navigator.clipboard.writeText(doc.id);
      document.getElementById('copyShort').onclick = () => navigator.clipboard.writeText(short);

      document.getElementById('openStudent').href = `${BASE}/s.html?code=${short}`;
      document.getElementById('openTeacher').href = `${BASE}/t.html?code=${short}`;

      // Also auto copy short code
      try { await navigator.clipboard.writeText(short); } catch {}
    }

    document.getElementById('createBtn').onclick = createDocument;
  </script>
</body>
</html>
