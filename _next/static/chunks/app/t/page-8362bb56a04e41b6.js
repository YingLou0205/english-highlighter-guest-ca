(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[708],{3465:function(e,t,s){Promise.resolve().then(s.bind(s,9782))},9376:function(e,t,s){"use strict";var a=s(5475);s.o(a,"useSearchParams")&&s.d(t,{useSearchParams:function(){return a.useSearchParams}})},9782:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return h}});var a=s(7437),n=s(2265),r=s(9376),i=s(5526);async function l(e){let{data:t,error:s}=await i.O.from("v_sentence_highlight_counts").select("normalized_text,example_text,freq").eq("document_id",e);if(s)throw s;let a=new Map;for(let e of null!=t?t:[]){let t=e.normalized_text,s=a.get(t);s?s.freq+=e.freq||0:a.set(t,{example_text:e.example_text,freq:e.freq||0})}return Array.from(a.values()).sort((e,t)=>t.freq-e.freq)}async function c(e){let{data:t,error:s}=await i.O.from("highlights").select("created_at, kind, text, user:profiles(full_name,id)").eq("document_id",e).order("created_at",{ascending:!1});if(s)throw s;return t}async function d(e){let{data:t,error:s}=await i.O.rpc("word_freq",{doc:e});if(s)throw s;return null!=t?t:[]}function o(e){let{items:t}=e,s=Math.max(1,...t.map(e=>e.cnt)),n=[...t];return n.sort((e,t)=>e.word>t.word?1:-1),(0,a.jsx)("div",{className:"flex flex-wrap gap-x-3 gap-y-2 p-3 rounded-xl bg-slate-50 border border-slate-200",style:{lineHeight:1.1},children:n.map((e,t)=>{let n=12+Math.round(e.cnt/s*28),r=.6+e.cnt/s*.4;return(0,a.jsx)("span",{className:"select-none",style:{fontSize:n,opacity:r},title:"".concat(e.word," \xd7").concat(e.cnt),children:e.word},t)})})}function u(){let e=((0,r.useSearchParams)().get("code")||"").trim(),[t,s]=(0,n.useState)(null),[u,h]=(0,n.useState)("Document"),[m,x]=(0,n.useState)([]),[f,p]=(0,n.useState)([]),[j,g]=(0,n.useState)([]),[y,N]=(0,n.useState)([]),[_,v]=(0,n.useState)([]),[b,w]=(0,n.useState)("");(0,n.useEffect)(()=>{(async()=>{w("");let{data:t,error:a}=await i.O.from("documents").select("id,title").eq("short_code",e).maybeSingle();if(a){w(a.message);return}if(!t){w("Document not found for this code.");return}s(t.id),t.title&&h(t.title);let[{data:n},{data:r}]=await Promise.all([i.O.from("paragraphs").select("id,text").eq("document_id",t.id).order("idx"),i.O.from("highlights").select("paragraph_id,start_offset,end_offset").eq("document_id",t.id)]);x(null!=n?n:[]),p(null!=r?r:[]);try{let[e,s,a]=await Promise.all([l(t.id),c(t.id),d(t.id)]);g(e),N(s),v(a)}catch(e){var o;w(null!==(o=e.message)&&void 0!==o?o:String(e))}})()},[e]);let S=(0,n.useMemo)(()=>(function(e,t){var s,a,n;let r={};for(let e of t)(null!==(a=r[s=e.paragraph_id])&&void 0!==a?a:r[s]=[]).push(e);let i=[];for(let t of e){let e=t.text.length,s=Array(e).fill(0);for(let a of null!==(n=r[t.id])&&void 0!==n?n:[]){let t=Math.max(0,Math.min(e,a.start_offset)),n=Math.max(t,Math.min(e,a.end_offset));for(let e=t;e<n;e++)s[e]+=1}let a=s.reduce((e,t)=>t>e?t:e,0),l=[];if(0===e){i.push({id:t.id,parts:[{t:"",freq:0}],max:a});continue}let c=0;for(;c<e;){let a=s[c],n=c+1;for(;n<e&&s[n]===a;)n++;l.push({t:t.text.slice(c,n),freq:a}),c=n}i.push({id:t.id,parts:l,max:a})}return i})(m,f),[m,f]);return e?b?(0,a.jsx)("div",{className:"container py-10 text-red-600",children:b}):t?(0,a.jsxs)("main",{className:"container py-10 space-y-10",children:[(0,a.jsx)("h1",{className:"text-2xl font-semibold",children:u}),(0,a.jsxs)("section",{className:"space-y-6",children:[S.map(e=>(0,a.jsx)("div",{className:"card leading-7",children:e.parts.map((t,s)=>{var n,r;return(0,a.jsx)("span",{style:{backgroundColor:(n=t.freq,r=e.max,n<=0||r<=0?"transparent":"hsl(48 96% ".concat(94-22*Math.max(0,Math.min(1,n/r)),"%)"))},children:t.t},s)})},e.id)),(0,a.jsx)("div",{className:"text-xs text-gray-600",children:"Heatmap color = frequency of student highlights."})]}),(0,a.jsxs)("section",{className:"space-y-2",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold",children:"Top Sentences / Spans"}),(0,a.jsx)("ul",{className:"space-y-1",children:j.map((e,t)=>(0,a.jsxs)("li",{className:"text-sm",children:[(0,a.jsx)("span",{className:"font-medium",children:e.example_text})," ",(0,a.jsxs)("span",{className:"text-gray-600",children:["\xd7",e.freq]})]},t))})]}),(0,a.jsxs)("section",{className:"space-y-2",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold",children:"Word Cloud"}),(0,a.jsx)(o,{items:_})]}),(0,a.jsxs)("section",{className:"space-y-2",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold",children:"Who highlighted what"}),(0,a.jsxs)("table",{className:"table",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{children:"User"}),(0,a.jsx)("th",{children:"Kind"}),(0,a.jsx)("th",{children:"Text"}),(0,a.jsx)("th",{children:"Time"})]})}),(0,a.jsx)("tbody",{children:y.map((e,t)=>{var s,n,r;return(0,a.jsxs)("tr",{className:"border-t",children:[(0,a.jsx)("td",{children:null!==(r=null===(s=e.user)||void 0===s?void 0:s.full_name)&&void 0!==r?r:null===(n=e.user)||void 0===n?void 0:n.id}),(0,a.jsx)("td",{className:"text-center",children:e.kind}),(0,a.jsx)("td",{className:"font-medium",children:e.text}),(0,a.jsx)("td",{className:"text-gray-600",children:new Date(e.created_at).toLocaleString()})]},t)})})]})]})]}):(0,a.jsx)("div",{className:"container py-10",children:"Loading…"}):(0,a.jsxs)("div",{className:"container py-10",children:["Missing ",(0,a.jsx)("code",{children:"code"})," in URL."]})}function h(){return(0,a.jsx)(n.Suspense,{fallback:(0,a.jsx)("div",{className:"container py-10",children:"Loading…"}),children:(0,a.jsx)(u,{})})}},5526:function(e,t,s){"use strict";s.d(t,{O:function(){return a}});let a=(0,s(8439).eI)("https://jjbsscygzuomnsfpzzex.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYnNzY3lnenVvbW5zZnB6emV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzQzMDksImV4cCI6MjA3MTYxMDMwOX0.kd3D0KsN0iekbJ9uPTEuQ0BTxAvopleychGiQ99ytsk")}},function(e){e.O(0,[439,971,117,744],function(){return e(e.s=3465)}),_N_E=e.O()}]);