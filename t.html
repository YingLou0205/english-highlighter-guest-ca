<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teacher • English Highlighter</title>
<link rel="icon" href="data:,"/>
<style>
  :root{--line:#e7e9ee;--muted:#5b6472}
  html,body{margin:0;padding:0;background:#fff;color:#0b1220;
    font:16px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji",sans-serif}
  .container{max-width:1000px;margin:40px auto;padding:0 20px}
  h1{font-size:24px;margin:0 0 16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px}
  .hint{color:var(--muted);font-size:13px}
  .para{border:1px solid var(--line);border-radius:14px;padding:14px}
  .section{margin-top:24px}
  .table{width:100%;border-collapse:collapse;font-size:14px}
  .table th,.table td{border-top:1px solid var(--line);padding:8px 6px;text-align:left}
  .cloud span{display:inline-block;margin:6px 8px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ── EDIT ─────────────────────────────────────────────────────────
  const SUPABASE_URL  = "YOUR_SUPABASE_URL";
  const SUPABASE_ANON = "YOUR_SUPABASE_ANON_KEY";
  // ─────────────────────────────────────────────────────────────────
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON,{auth:{persistSession:true,autoRefreshToken:true}});
  function q(k){ return new URL(location.href).searchParams.get(k)||""; }

  async function ensureSession(){
    const { data:{ session } } = await supabase.auth.getSession();
    if (session) return session.user;
    let creds = JSON.parse(localStorage.getItem("guestCreds")||"{}");
    if(!creds.email || !creds.password){
      creds = { email: `guest+${crypto.randomUUID()}@guest.local`, password: crypto.randomUUID() };
      localStorage.setItem("guestCreds", JSON.stringify(creds));
    }
    let { error } = await supabase.auth.signInWithPassword(creds);
    if (error) await supabase.auth.signUp({ email: creds.email, password: creds.password });
    return (await supabase.auth.getUser()).data.user;
  }

  async function loadByShort(code){
    let { data } = await supabase.from("documents").select("id,title,content,short_code").eq("short_code", code).maybeSingle();
    if (!data){
      const all = await supabase.from("documents").select("id,title,content").like("id", `${code}%`);
      data = (all.data||[])[0]||null;
    }
    if (!data) throw new Error("Document not found for code: " + code);
    return data;
  }

  // Build heatmap spans: intensity 0..1 mapped to rgba(255,111,0, alpha)
  function buildHeatmapHTML(text, ranges){
    if(!ranges.length) return text;
    // sweep line to compute coverage
    const pts=[];
    for(const r of ranges){ pts.push([r.start,+1]); pts.push([r.end,-1]); }
    pts.sort((a,b)=>a[0]-b[0]);
    let i=0, cov=0, parts=[];
    for(const [x,delta] of pts){
      if(i<x){ parts.push({t:text.slice(i,x),c:cov}); i=x; }
      cov += delta;
    }
    if(i<text.length) parts.push({t:text.slice(i),c:cov});
    const max = Math.max(1, ...parts.map(p=>p.c));
    const map = v => Math.max(0.10, Math.min(0.65, v/max*0.65)); // readable range
    return parts.map(p=>{
      if(!p.c) return p.t
      return `<span style="background:rgba(255,111,0,${map(p.c)}); border-radius:4px; padding:1px 2px">${p.t}</span>`
    }).join("");
  }

  function normalize(s){ return s.toLowerCase().normalize("NFKD").replace(/\p{Diacritic}/gu,"").replace(/\s+/g," ").trim(); }

  document.addEventListener("DOMContentLoaded", async () => {
    try{
      await ensureSession();
      const code = q("code");
      const doc = await loadByShort(code);
      document.getElementById("title").textContent = doc.title;

      // paragraphs
      const { data: paras } = await supabase.from("paragraphs").select("id,idx,text").eq("document_id",doc.id).order("idx");

      // all highlights for heatmap + stats
      const { data: all } = await supabase.from("highlights")
        .select("paragraph_id,start_offset,end_offset,text,kind,created_at, user:profiles(full_name)")
        .eq("document_id", doc.id);

      // render doc with heatmap
      const paraWrap=document.getElementById("doc");
      for(const p of (paras||[])){
        const r = (all||[]).filter(h=>h.paragraph_id===p.id).map(h=>({start:h.start_offset,end:h.end_offset}));
        const html = buildHeatmapHTML(p.text,r);
        const sec=document.createElement("section"); sec.className="para"; sec.innerHTML=html;
        paraWrap.append(sec);
      }
      document.getElementById("heatHint").style.display="block";

      // Top “sentences/spans” = actually count ALL highlights by normalized text
      const counts = new Map();
      for(const h of (all||[])){
        const k = normalize(h.text);
        counts.set(k, (counts.get(k)||{text:h.text, freq:0}));
        counts.get(k).freq++;
      }
      const top = [...counts.values()].sort((a,b)=>b.freq-a.freq).slice(0,50);
      const ul=document.getElementById("top");
      top.forEach(row=>{
        const li=document.createElement("li");
        li.textContent = `${row.text} ×${row.freq}`;
        ul.append(li);
      });

      // Word cloud (simple tag cloud)
      const cloudWrap=document.getElementById("cloud");
      const wordCounts=new Map();
      for(const h of (all||[])){
        (h.text||"").toLowerCase().split(/\W+/).forEach(w=>{
          if(w.length<3) return;
          if("the,and,for,are,but,not,you,with,this,that,was,have,from,they,his,her,she,him,our,your,their,will,would,there,what,when,where,who,why,how,all,any,can,could,should,about,into,over,after,before,while,to,in,on,of,a,an,is,it,as,be,by,or,if,at,we,i,me,my,mine,so,do,does,did,done".includes(w)) return;
          wordCounts.set(w,(wordCounts.get(w)||0)+1);
        })
      }
      const entries=[...wordCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,60);
      const maxWC=Math.max(1,...entries.map(e=>e[1]));
      entries.forEach(([w,c])=>{
        const s = 12 + Math.round((c/maxWC)*28);
        const span=document.createElement("span");
        span.style.fontSize = s+"px";
        span.textContent = w;
        cloudWrap.append(span);
      });

      // Who highlighted what (audit)
      const tb=document.getElementById("audit");
      (all||[]).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at)).forEach(h=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${h.user?.full_name||"Unknown"}</td><td>${h.kind}</td><td>${h.text}</td><td>${new Date(h.created_at).toLocaleString()}</td>`;
        tb.append(tr);
      });

    }catch(e){ alert(e.message); }
  });
</script>
</head>
<body>
  <main class="container">
    <h1 id="title">Loading…</h1>

    <section class="card">
      <div id="doc" style="display:grid;gap:14px"></div>
      <div id="heatHint" class="hint" style="display:none;margin-top:6px">Heatmap color = frequency of student highlights (lighter = fewer, darker = more).</div>
    </section>

    <section class="section">
      <h2 style="margin:0 0 6px;font-size:18px">Top Sentences / Spans</h2>
      <ul id="top" class="card" style="list-style:none;padding-left:16px"></ul>
    </section>

    <section class="section">
      <h2 style="margin:0 0 6px;font-size:18px">Word Cloud</h2>
      <div id="cloud" class="card cloud"></div>
    </section>

    <section class="section">
      <h2 style="margin:0 0 6px;font-size:18px">Who highlighted what</h2>
      <div class="card">
        <table class="table">
          <thead><tr><th>User</th><th>Kind</th><th>Text</th><th>Time</th></tr></thead>
          <tbody id="audit"></tbody>
        </table>
      </div>
    </section>
  </main>
</body>
</html>
