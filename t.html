<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Teacher</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
  <style>
    body{ margin:0; font:16px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#0f172a; }
    .container{ max-width:1000px; margin:0 auto; padding:36px 24px; }
    .h1{ font-size:24px; font-weight:700; margin:0 0 16px; }
    .card{ border:1px solid #e5e7eb; border-radius:16px; padding:18px 20px; box-shadow:0 1px 2px rgba(0,0,0,.04); background:#fff; }
    .muted{ color:#64748b; font-size:13px; }
    .btn{ background:#000; color:#fff; border:1px solid #000; border-radius:12px; padding:8px 12px; cursor:pointer; }
    .table{ width:100%; border-collapse:collapse; }
    .table th,.table td{ padding:10px 8px; border-top:1px solid #e5e7eb; font-size:14px; }
    .badge{ font-variant-numeric: tabular-nums; background:#0f172a; color:#fff; border-radius:10px; padding:2px 8px; font-size:12px; }
  </style>
</head>
<body>
  <main class="container">
    <h1 id="title" class="h1">Loading…</h1>

    <section id="docView" class="card" style="margin-bottom:10px"></section>
    <div class="muted" style="margin:6px 2px 18px">Heatmap color = frequency of student highlights (darker = more students).</div>

    <section class="card" style="margin-bottom:18px">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
        <h2 style="margin:0; font-size:18px; font-weight:700;">Top Sentences / Spans</h2>
        <button id="csv" class="btn">Export CSV</button>
      </div>
      <ul id="topList" style="margin:0; padding-left:18px;"></ul>
    </section>

    <section class="card" style="margin-bottom:18px">
      <h2 style="margin:0 0 10px; font-size:18px; font-weight:700;">Word Cloud</h2>
      <div id="cloud" style="font-size:32px; line-height:1.3; word-wrap:break-word;"></div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px; font-size:18px; font-weight:700;">Who highlighted what</h2>
      <table class="table">
        <thead><tr><th>User</th><th>Kind</th><th>Text</th><th>Time</th></tr></thead>
        <tbody id="audit"></tbody>
      </table>
    </section>
  </main>

  <script>
    const SUPABASE = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    const code = new URL(location.href).searchParams.get('code');

    (async () => {
      const { data: doc } = await SUPABASE.from('documents').select('id,title,content').eq('short_code', code).single();
      if (!doc) { alert('Invalid code'); return; }
      document.getElementById('title').textContent = doc.title;

      // paragraphs
      const { data: paras } = await SUPABASE.from('paragraphs').select('id,idx,text').eq('document_id', doc.id).order('idx');

      // all highlights (for heatmap + stats)
      const { data: highs } = await SUPABASE
        .from('highlights')
        .select('id,paragraph_id,start_offset,end_offset,text,kind,user_name,created_at')
        .eq('document_id', doc.id);

      // -------------- Render document with heat map --------------
      const wrap = document.getElementById('docView');
      wrap.innerHTML = '';
      const byPara = new Map();
      (highs||[]).forEach(h => {
        if (!byPara.has(h.paragraph_id)) byPara.set(h.paragraph_id, []);
        byPara.get(h.paragraph_id).push(h);
      });

      // compute global max “unique users covering a char”
      let globalMax = 1;
      for (const p of (paras||[])) {
        const arr = coverageCounts(p.text, byPara.get(p.id)||[]);
        const max = Math.max(1, ...arr);
        if (max > globalMax) globalMax = max;
      }

      for (const p of (paras||[])) {
        const div = document.createElement('div');
        div.style.margin = '12px 0';
        const counts = coverageCounts(p.text, byPara.get(p.id)||[]);
        div.innerHTML = paintHeat(p.text, counts, globalMax);
        wrap.appendChild(div);
      }

      // -------------- Top Sentences/Spans (count **all** highlights) --------------
      const counts = new Map();  // normalized text -> freq
      (highs||[]).forEach(h => {
        const norm = normalize(h.text);
        if (!norm) return;
        counts.set(norm, (counts.get(norm)||0) + 1);
      });
      const top = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,50);
      const ul = document.getElementById('topList'); ul.innerHTML = '';
      top.forEach(([t,f]) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="badge">×${f}</span> <span style="margin-left:8px">${escapeHtml(t)}</span>`;
        ul.appendChild(li);
      });

      // -------------- Word cloud (simple) --------------
      const cloudBox = document.getElementById('cloud');
      cloudBox.textContent = ''; // clear
      const words = {};
      (highs||[]).forEach(h => {
        for (const w of normalize(h.text).split(/\W+/)) {
          if (w.length < 3 || STOP.has(w)) continue;
          words[w] = (words[w]||0)+1;
        }
      });
      const entries = Object.entries(words).sort((a,b)=>b[1]-a[1]).slice(0,30);
      cloudBox.innerHTML = entries.map(([w,c]) => `<span style="font-weight:600; font-size:${16 + Math.min(36, c*4)}px; margin-right:14px">${escapeHtml(w)}</span>`).join(' ');

      // -------------- Audit table --------------
      const tbody = document.getElementById('audit'); tbody.innerHTML = '';
      (highs||[]).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at)).forEach(h => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(h.user_name||'')}</td>
                        <td>${h.kind}</td>
                        <td style="font-weight:600">${escapeHtml(h.text)}</td>
                        <td style="color:#64748b">${new Date(h.created_at).toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });

      // -------------- CSV export --------------
      document.getElementById('csv').onclick = () => {
        const headers = ['paragraph_index','kind','text','user','start_offset','end_offset','created_at'];
        const indexByPara = new Map((paras||[]).map(p=>[p.id, p.idx]));
        const rows = (highs||[]).map(h => ({
          paragraph_index: indexByPara.get(h.paragraph_id) ?? '',
          kind: h.kind, text: h.text, user: h.user_name,
          start_offset: h.start_offset, end_offset: h.end_offset, created_at: h.created_at
        }));
        const esc = v => {
          if (v==null) return '';
          const s = String(v);
          const needs = s.indexOf(',')!==-1 || s.indexOf('"')!==-1 || s.indexOf('\n')!==-1;
          return needs ? `"${s.split('"').join('""')}"` : s;
        };
        const csv = [headers.join(',')].concat(rows.map(r => headers.map(h => esc(r[h])).join(','))).join('\n');
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='highlights.csv';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      };
    })();

    // ----- helpers -----
    function normalize(t){ return (t||'').toLowerCase().normalize('NFKC').replace(/\s+/g,' ').trim(); }
    const STOP = new Set(['the','and','for','are','but','not','you','with','this','that','was','have','from','they','his','her','she','him','our','your','their','will','would','there','what','when','where','who','why','how','all','any','can','could','should','about','into','over','after','before','while','to','in','on','of','a','an','is','it','as','be','by','or','if','at','we','i','me','my','mine','so','do','does','did','done']);

    // For each character, count number of UNIQUE users covering that char
    function coverageCounts(text, highlights){
      const n = (text||'').length;
      const per = Array.from({length:n}, ()=> new Set());
      (highlights||[]).forEach(h => {
        const s = Math.max(0, Math.min(n, h.start_offset|0));
        const e = Math.max(s, Math.min(n, h.end_offset|0));
        for (let i=s; i<e; i++) per[i].add(h.user_name||'');
      });
      return per.map(s => s.size);
    }

    // Turn counts into colored spans. HSL orange hue, alpha 0.12 → 0.55
    function paintHeat(text, counts, globalMax){
      if (!counts.length) return escapeHtml(text||'');
      const out = [];
      let i=0, n=text.length;
      function colorFor(c){
        if (!c) return '';
        const alpha = 0.12 + 0.43 * (c / globalMax);
        return `background: hsla(36, 100%, 50%, ${alpha.toFixed(3)}); border-radius:4px;`;
      }
      while (i<n){
        const c = counts[i];
        let j=i+1;
        while (j<n && counts[j]===c) j++;
        const slice = escapeHtml(text.slice(i,j));
        out.push(c ? `<span style="${colorFor(c)}">${slice}</span>` : slice);
        i=j;
      }
      return out.join('');
    }
    function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]))}
  </script>
</body>
</html>
