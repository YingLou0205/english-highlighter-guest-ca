(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[905],{5767:function(e,t,s){Promise.resolve().then(s.bind(s,3741))},9376:function(e,t,s){"use strict";var n=s(5475);s.o(n,"useSearchParams")&&s.d(t,{useSearchParams:function(){return n.useSearchParams}})},3741:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return o}});var n=s(7437),a=s(2265),i=s(9376),r=s(5526);function l(e,t,s){let n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),a=0;for(;n.nextNode();){let e=n.currentNode;if(e===t)return a+s;a+=e.data.length}return a}function d(e){let{paragraph:t,documentId:s,userId:i}=e,d=(0,a.useRef)(null),[c,o]=(0,a.useState)([]),[u,h]=(0,a.useState)("");async function f(){var e,n;if(!i){h("Please sign in.");return}let a=function(e){let t=window.getSelection();if(!t||t.isCollapsed)return null;let s=t.getRangeAt(0);if(!e.contains(s.startContainer)||!e.contains(s.endContainer))return null;let n=l(e,s.startContainer,s.startOffset),a=l(e,s.endContainer,s.endOffset),i=Math.min(n,a),r=Math.max(n,a),d=e.innerText.slice(i,r);return{start:i,end:r,text:d}}(d.current);if(a&&0!==a.text.trim().length)try{let n=a.text.trim().includes(" ")?"sentence":"word",l=await r.O.from("highlights").insert({document_id:s,paragraph_id:t.id,user_id:i,start_offset:a.start,end_offset:a.end,text:a.text,kind:n}).select("id,start_offset,end_offset,text").single();if(l.error)throw l.error;let d=l.data;o(e=>[...e,d]),null===(e=window.getSelection())||void 0===e||e.removeAllRanges()}catch(e){h(null!==(n=e.message)&&void 0!==n?n:String(e))}}async function m(e){try{let t=await r.O.from("highlights").delete().eq("id",e).eq("user_id",i);if(t.error)throw t.error;o(t=>t.filter(t=>t.id!==e))}catch(e){var t;h(null!==(t=e.message)&&void 0!==t?t:String(e))}}(0,a.useEffect)(()=>{if(!i)return;(async()=>{let{data:e,error:s}=await r.O.from("highlights").select("id,start_offset,end_offset,text").eq("paragraph_id",t.id).eq("user_id",i).order("created_at",{ascending:!0});s||o(null!=e?e:[])})();let e=r.O.channel("hl-".concat(t.id,"-").concat(i)).on("postgres_changes",{event:"INSERT",schema:"public",table:"highlights",filter:"paragraph_id=eq."+t.id},e=>{let t=e.new;t&&t.user_id===i&&o(e=>[...e,{id:t.id,start_offset:t.start_offset,end_offset:t.end_offset,text:t.text}])}).on("postgres_changes",{event:"DELETE",schema:"public",table:"highlights",filter:"paragraph_id=eq."+t.id},e=>{let t=e.old;t&&o(e=>e.filter(e=>e.id!==t.id))}).subscribe();return()=>{r.O.removeChannel(e)}},[t.id,i]);let g=(0,a.useMemo)(()=>{let e=c.map(e=>({start:e.start_offset,end:e.end_offset}));if(!e.length)return[];e.sort((e,t)=>e.start-t.start);let t=[{...e[0]}];for(let s of e.slice(1)){let e=t[t.length-1];s.start<=e.end?e.end=Math.max(e.end,s.end):t.push({...s})}return t},[c]),p=(0,a.useMemo)(()=>{let e=t.text;if(!g.length)return[{t:e,hl:!1}];let s=[],n=0;for(let t of g)n<t.start&&s.push({t:e.slice(n,t.start),hl:!1}),s.push({t:e.slice(t.start,t.end),hl:!0}),n=t.end;return n<e.length&&s.push({t:e.slice(n),hl:!1}),s},[g,t.text]);return(0,n.jsxs)("div",{className:"leading-7 space-y-2",children:[u&&(0,n.jsx)("div",{className:"text-red-600 text-sm",children:u}),(0,n.jsx)("div",{ref:d,onMouseUp:f,className:"cursor-text select-text",children:p.map((e,t)=>(0,n.jsx)("span",{className:e.hl?"bg-emerald-200":"",children:e.t},t))}),c.length>0&&(0,n.jsx)("div",{className:"flex flex-wrap gap-2 pt-1",children:c.map(e=>{let t=e.text.length>32?e.text.slice(0,32)+"…":e.text;return(0,n.jsxs)("button",{onClick:()=>m(e.id),className:"text-xs px-2 py-1 border rounded-lg hover:bg-red-50",title:"Remove this highlight",children:[t," \xd7"]},e.id)})})]})}function c(){let e=((0,i.useSearchParams)().get("code")||"").trim(),[t,s]=(0,a.useState)(null),[l,c]=(0,a.useState)("Document"),[o,u]=(0,a.useState)([]),[h,f]=(0,a.useState)(""),[m,g]=(0,a.useState)(""),[p,x]=(0,a.useState)("");async function _(){try{x("");let e=h;if(!e){(await r.O.auth.getSession()).data.session||await r.O.auth.signInAnonymously();let t=(await r.O.auth.getUser()).data.user;t&&(e=t.id,f(t.id))}if(!e)throw Error("Unable to sign in. Please try again.");let t=m.trim()||"Guest",{error:s}=await r.O.from("profiles").upsert({id:e,full_name:t});if(s)throw s}catch(t){var e;x(null!==(e=t.message)&&void 0!==e?e:String(t))}}return((0,a.useEffect)(()=>{(async()=>{x(""),(await r.O.auth.getSession()).data.session||await r.O.auth.signInAnonymously();let t=(await r.O.auth.getUser()).data.user;if(t){f(t.id);let{data:e}=await r.O.from("profiles").select("full_name").eq("id",t.id).maybeSingle();(null==e?void 0:e.full_name)&&g(e.full_name)}let{data:n,error:a}=await r.O.from("documents").select("id,title").eq("short_code",e).maybeSingle();if(a){x(a.message);return}if(!n){x("Document not found for this code.");return}s(n.id),n.title&&c(n.title);let{data:i,error:l}=await r.O.from("paragraphs").select("id,text").eq("document_id",n.id).order("idx");if(l){x(l.message);return}u(null!=i?i:[])})()},[e]),e)?p?(0,n.jsx)("div",{className:"container py-10 text-red-600",children:p}):t?(0,n.jsxs)("main",{className:"container py-10 space-y-6",children:[(0,n.jsx)("h1",{className:"text-xl font-semibold",children:l}),(0,n.jsxs)("div",{className:"card max-w-lg space-y-2",children:[(0,n.jsx)("div",{className:"text-sm font-medium",children:"Your name (shown to teacher)"}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)("input",{className:"input",value:m,onChange:e=>g(e.target.value),placeholder:"e.g., Ying"}),(0,n.jsx)("button",{className:"btn btn-primary",onClick:_,children:"Save"})]})]}),(0,n.jsx)("div",{className:"space-y-6",children:o.map(e=>(0,n.jsx)("div",{className:"card",children:(0,n.jsx)(d,{paragraph:e,documentId:t,userId:h})},e.id))})]}):(0,n.jsx)("div",{className:"container py-10",children:"Loading…"}):(0,n.jsxs)("div",{className:"container py-10",children:["Missing ",(0,n.jsx)("code",{children:"code"})," in URL."]})}function o(){return(0,n.jsx)(a.Suspense,{fallback:(0,n.jsx)("div",{className:"container py-10",children:"Loading…"}),children:(0,n.jsx)(c,{})})}},5526:function(e,t,s){"use strict";s.d(t,{O:function(){return n}});let n=(0,s(8439).eI)("https://jjbsscygzuomnsfpzzex.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYnNzY3lnenVvbW5zZnB6emV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzQzMDksImV4cCI6MjA3MTYxMDMwOX0.kd3D0KsN0iekbJ9uPTEuQ0BTxAvopleychGiQ99ytsk")}},function(e){e.O(0,[439,971,117,744],function(){return e(e.s=5767)}),_N_E=e.O()}]);