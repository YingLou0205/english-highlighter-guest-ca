<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Create a Document • English Highlighter</title>
<link rel="icon" href="data:,"/>
<style>
  :root{--bg:#fff;--text:#0b1220;--muted:#5b6472;--line:#e7e9ee;--btn:#0b1220;--btnText:#fff;--ok:#0ea5e9}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font:16px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji",sans-serif}
  .container{max-width:980px;margin:40px auto;padding:0 20px}
  h1{font-size:28px;margin:0 0 18px}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .input{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;font:inherit}
  .btn{appearance:none;border:0;border-radius:12px;background:var(--btn);color:var(--btnText);padding:12px 16px;font-weight:600;cursor:pointer}
  .hint{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .copy{margin-left:8px; padding:8px 10px; border-radius:10px; background:#0b1220; color:#fff; border:0; cursor:pointer}
  code{background:#f6f7f9;border:1px solid var(--line);padding:8px 10px;border-radius:12px;word-break:break-all}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ── EDIT ─────────────────────────────────────────────────────────
  const SUPABASE_URL  = "YOUR_SUPABASE_URL";
  const SUPABASE_ANON = "YOUR_SUPABASE_ANON_KEY";
  const BASE = "/english-highlighter-guest-ca";
  // ─────────────────────────────────────────────────────────────────
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth: { persistSession: true, autoRefreshToken: true }
  });

  async function ensureSession(){
    const { data:{ session } } = await supabase.auth.getSession();
    if (session) return session.user;
    let creds = JSON.parse(localStorage.getItem("guestCreds")||"{}");
    if(!creds.email || !creds.password){
      creds = { email: `guest+${crypto.randomUUID()}@guest.local`, password: crypto.randomUUID() };
      localStorage.setItem("guestCreds", JSON.stringify(creds));
    }
    let { error } = await supabase.auth.signInWithPassword(creds);
    if (error) {
      const r = await supabase.auth.signUp({ email: creds.email, password: creds.password });
      if (r.error) alert("Sign-up failed: " + r.error.message);
    }
    const u = (await supabase.auth.getUser()).data.user;
    await supabase.from("profiles").upsert({ id: u.id, full_name: "Guest" });
    return u;
  }

  async function copyText(text){ await navigator.clipboard?.writeText(text).catch(()=>{}); }

  document.addEventListener("DOMContentLoaded", async () => {
    const user = await ensureSession();

    // name save
    document.getElementById("saveName").onclick = async () => {
      const name = document.getElementById("displayName").value.trim() || "Guest";
      await supabase.from("profiles").upsert({ id: user.id, full_name: name });
      alert("Saved name as: " + name);
    };

    // create document
    document.getElementById("createBtn").onclick = async () => {
      const title = document.getElementById("title").value.trim();
      const content = document.getElementById("content").value.trim();
      if(!title || !content){ alert("Please enter a title and paste content."); return; }

      // Insert document (owner = created_by)
      const { data: doc, error: e1 } = await supabase
        .from("documents")
        .insert({ title, content, created_by: user.id })
        .select()
        .single();
      if (e1){ alert("Create failed: " + e1.message); return; }

      // Split paragraphs on blank lines
      const paras = content.split(/\n\s*\n+/).map((t,i)=>({ document_id: doc.id, idx:i, text:t.trim() })).filter(r=>r.text);
      const { error: e2 } = await supabase.from("paragraphs").insert(paras);
      if (e2){ alert("Failed to save paragraphs: " + e2.message); return; }

      // Short code (if your DB has short_code, prefer that; else fallback to id slice)
      const short = doc.short_code || doc.id.replace(/-/g,'').slice(0,8);

      // Show result
      document.getElementById("resultCard").style.display = "block";
      document.getElementById("docId").textContent = doc.id;
      document.getElementById("short").textContent = short;

      // Copy buttons
      document.getElementById("copyDocId").onclick = ()=>copyText(doc.id);
      document.getElementById("copyShort").onclick = ()=>copyText(short);

      // Open links
      document.getElementById("openS").onclick = ()=>location.href = `${BASE}/s.html?code=${short}`;
      document.getElementById("openT").onclick = ()=>location.href = `${BASE}/t.html?code=${short}`;
    };
  });
</script>
</head>
<body>
  <main class="container">
    <h1>Create a Document</h1>

    <section class="grid" style="margin-bottom:16px">
      <div class="card">
        <div class="hint">Your display name (shown to class)</div>
        <div class="row" style="margin-top:8px">
          <input id="displayName" class="input" placeholder="e.g., Alice" />
          <button id="saveName" class="btn">Save name</button>
        </div>
      </div>
      <div class="card">
        <div class="hint">Your role</div>
        <div class="row" style="margin-top:8px">
          <button class="btn" disabled>Student</button>
          <button class="btn" disabled style="opacity:.35">Teacher (owner by creator)</button>
        </div>
        <div class="hint">Role is only used for teacher analytics; the creator is the owner.</div>
      </div>
    </section>

    <section class="card" style="margin-bottom:16px">
      <div class="hint">Title</div>
      <input id="title" class="input" placeholder="e.g., Chapter 1" style="margin-top:8px"/>
      <div class="hint" style="margin-top:14px">Content (blank line = new paragraph)</div>
      <textarea id="content" class="input" rows="12" placeholder="Paragraph 1...\n\nParagraph 2..." style="margin-top:8px"></textarea>
      <div class="row" style="margin-top:14px">
        <button id="createBtn" class="btn">Create document</button>
      </div>
    </section>

    <section id="resultCard" class="card" style="display:none">
      <div class="hint" style="color:#047857">✅ Document created.</div>
      <div class="row" style="margin-top:10px;align-items:center">
        <div style="flex:1">
          <div class="hint">Document ID</div>
          <code id="docId"></code>
        </div>
        <button id="copyDocId" class="copy">Copy</button>
      </div>
      <div class="row" style="margin-top:10px;align-items:center">
        <div style="flex:1">
          <div class="hint">Short Code</div>
          <code id="short"></code>
        </div>
        <button id="copyShort" class="copy">Copy</button>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="openS" class="btn">Open Student View</button>
        <button id="openT" class="btn">Open Teacher View</button>
      </div>
      <div class="hint" style="margin-top:6px">Tip: Short Code was copied automatically.</div>
    </section>
  </main>
</body>
</html>
